<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="Quadplane LisaM_2.0 pwm">

	<description>
		Quadplane:
		- modified mini-talon with cobra 2814/16 Kv1050 running a 10x8 prop
		- quad with KISS esc + cobra 2207/2450kv running 6x3 props
	</description>

	<!-- FIRMWARE -->

	<firmware name="rotorcraft">

		<target name="ap" board="lisa_mx_2.1">
			<!-- MPU6000 is configured to output data at 2kHz, but polled at 512Hz PERIODIC_FREQUENCY -->
		</target>

		<target name="nps" board="pc">
			<module name="fdm" type="jsbsim"/>
		</target>

		<module name="radio_control" type="spektrum">
			<define name="RADIO_MODE"						value="RADIO_GEAR"/>
			<define name="RADIO_FORWARD_MODE"				value="RADIO_AUX2"/>
			<define name="RADIO_KILL_SWITCH"				value="RADIO_AUX1"/>
			<define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING"	value="1" />
		</module>

		<module name="actuators" type="pwm">
			<define name="SERVO_HZ" value="400"/>
			<define name="USE_SERVOS_7AND8"/>
		</module>

		<module name="telemetry" type="xbee_api"/>
		<module name="imu" type="aspirin_v2.2"/>
		<module name="gps" type="datalink"/>

		<module name="stabilization" type="inca">
			<define name="INDI_RPM_FEEDBACK" value="TRUE"/>
		</module>

		<module name="ahrs" type="int_cmpl_quat">
			<configure	name="USE_MAGNETOMETER"					value="FALSE"/>
			<define		name="AHRS_GRAVITY_HEURISTIC_FACTOR"	value="0"/>
		</module>

		<module name="ins" type="extended"/>
		<module name="geo_mag"/>
		<module name="air_data"/>

		<!--define name="KILL_ON_GROUND_DETECT" value="TRUE"/-->

	</firmware>

	<!-- COMMANDS -->

	<commands>
		<axis name="ROLL"			failsafe_value="0"/>
		<axis name="PITCH"			failsafe_value="0"/>
		<axis name="YAW"			failsafe_value="0"/>
		<axis name="THRUST"			failsafe_value="0"/>
		<axis name="FORWARD_MODE"	failsafe_value="0"/>
	</commands>

	<rc_commands>
		<set command="FORWARD_MODE" value="@FORWARD_MODE"/>
	</rc_commands>

	<!-- SERVOS -->

	<servos driver="Pwm">
		<servo name="FRONT_LEFT"		no="0" min="1000" neutral="1100" max="1900"/>
		<servo name="FRONT_RIGHT"		no="1" min="1000" neutral="1100" max="1900"/>
		<servo name="BACK_RIGHT"		no="2" min="1000" neutral="1100" max="1900"/>
		<servo name="BACK_LEFT"			no="3" min="1000" neutral="1100" max="1900"/>
		<servo name="FLYMOTOR"			no="4" min="1000" neutral="1100" max="1900"/>
		<servo name="AILERONS"			no="5" min="1000" neutral="1470" max="1900"/>
		<servo name="RUDDERVATOR_LEFT"	no="6" min="1000" neutral="1500" max="2000"/>
		<servo name="RUDDERVATOR_RIGHT"	no="7" min="1000" neutral="1470" max="2000"/>
	</servos>

	<!-- COMMANDS LAWS -->

	<command_laws>

		<!-- Variables indicating if a certain actuator set is active -->
		<let var="fixed_wing_on"		value="@FORWARD_MODE >= -4800? autopilot_get_motors_on() : 0"/>
		<let var="quad_on"				value="@FORWARD_MODE <= 4800? autopilot_get_motors_on() : 0"/>

		<!-- Variables used for ruddervator calculations -->
		<let var="elevator"				value="@PITCH * 1.5"/>
		<let var="rudder"				value="@YAW * 1.2"/>

		<!-- Quadcopter actuatortor set -->
		<set servo="FRONT_LEFT"			value="$quad_on ? actuators_pprz[0] : -MAX_PPRZ"/>
		<set servo="FRONT_RIGHT"		value="$quad_on ? actuators_pprz[1] : -MAX_PPRZ"/>
		<set servo="BACK_RIGHT"			value="$quad_on ? actuators_pprz[2] : -MAX_PPRZ"/>
		<set servo="BACK_LEFT"			value="$quad_on ? actuators_pprz[3] : -MAX_PPRZ"/>

		<!-- Fixed wing actuator set -->
		<set servo="FLYMOTOR"			value="$fixed_wing_on * @THRUST"/>
		<set servo="AILERONS"			value="$fixed_wing_on * @ROLL * 1.3"/>
		<set servo="RUDDERVATOR_RIGHT"	value="$fixed_wing_on * (-$elevator - $rudder)"/>
		<set servo="RUDDERVATOR_LEFT"	value="$fixed_wing_on * ( $elevator - $rudder)"/>
		<set servo="AILERONS"			value="$fixed_wing_on * @ROLL * 1.3"/>

	</command_laws>

	<!-- SETTINGS -->

	<section name="IMU" prefix="IMU_">

		<!-- Replace this with your own calibration -->
		<define name="MAG_X_NEUTRAL"		value="-102"/>
		<define name="MAG_Y_NEUTRAL"		value="-69"/>
		<define name="MAG_Z_NEUTRAL"		value="96"/>
		<define name="MAG_X_SENS"			value="3.7163763222485424"	integer="16"/>
		<define name="MAG_Y_SENS"			value="3.667894315633858"	integer="16"/>
		<define name="MAG_Z_SENS"			value="4.040080277772171"	integer="16"/>

		<define name="BODY_TO_IMU_PHI"		value="0."					unit="deg"/>
		<define name="BODY_TO_IMU_THETA"	value="0."					unit="deg"/>
		<define name="BODY_TO_IMU_PSI"		value="180."				unit="deg"/>

	</section>

	<section name="AHRS" prefix="AHRS_">

		<!-- Delft magnetic field -->
		<define name="H_X"							value="0.39049610"/>
		<define name="H_Y"							value="0.00278894"/>
		<define name="H_Z"							value="0.92060036"/>
		<define name="USE_GPS_HEADING"				value="1"/>
		<define name="HEADING_UPDATE_GPS_MIN_SPEED"	value="0"/>

		<!-- For vibrating airfames -->
		<define name="GRAVITY_HEURISTIC_FACTOR"		value="0"/>

	</section>

	<section name="INS" prefix="INS_">
		<define name="USE_GPS_ALT"			value="1"/>
		<define name="USE_GPS_ALT_SPEED"	value="1"/>
	</section>

	<section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">

		<!-- Setpoints -->
		<define name="SP_MAX_PHI"	value="45."		unit="deg"/>
		<define name="SP_MAX_THETA"	value="45."		unit="deg"/>
		<define name="SP_MAX_R"		value="90."		unit="deg/s"/>
		<define name="DEADBAND_A"	value="0"/>
		<define name="DEADBAND_E"	value="0"/>
		<define name="DEADBAND_R"	value="250"/>

		<!-- Reference -->
		<define name="REF_OMEGA_P"	value="400"		unit="deg/s"/>
		<define name="REF_ZETA_P"	value="0.85"/>
		<define name="REF_MAX_P"	value="400."	unit="deg/s"/>
		<define name="REF_MAX_PDOT"	value="RadOfDeg(8000.)"/>

		<define name="REF_OMEGA_Q"	value="400"		unit="deg/s"/>
		<define name="REF_ZETA_Q"	value="0.85"/>
		<define name="REF_MAX_Q"	value="400."	unit="deg/s"/>
		<define name="REF_MAX_QDOT"	value="RadOfDeg(8000.)"/>

		<define name="REF_OMEGA_R"	value="250"		unit="deg/s"/>
		<define name="REF_ZETA_R"	value="0.85"/>
		<define name="REF_MAX_R"	value="180."	unit="deg/s"/>
		<define name="REF_MAX_RDOT"	value="RadOfDeg(1800.)"/>

	</section>

	<section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">

		<!-- Control effectiveness, have been determined by flying test flights with adaptive turned on./-->
		<define name="G1_ROLL"					value="{ 11.0,  -11.0,  -11.0 , 11.0 }"/>
		<define name="G1_PITCH"					value="{  8.5 ,   8.5,   -8.5 , -8.5 }"/>
		<define name="G1_YAW"					value="{ -0.50,   0.50,  -0.50,  0.50}"/>
		<define name="G1_THRUST"				value="{  -.40,   -.40,   -.40,  -.40}"/>

		<!--Counter torque effect of spinning up a rotor-->
		<define name="G2"						value="{-48.0,   48.0,   -48.0, 48.0 }"/>

		<!-- reference acceleration for attitude control -->
		<define name="REF_ERR_P"				value="600.0"/>
		<define name="REF_ERR_Q"				value="600.0"/>
		<define name="REF_ERR_R"				value="600.0"/>
		<define name="REF_RATE_P"				value="28.0"/>
		<define name="REF_RATE_Q"				value="28.0"/>
		<define name="REF_RATE_R"				value="28.0"/>

		<define name="ESTIMATION_FILT_CUTOFF"	value="4.0"/>
		<define name="FILT_CUTOFF"				value="5.0"/>

		<!-- first order actuator dynamics -->
		<define name="ACT_DYN"					value="{0.1, 0.1, 0.1, 0.1}"/>

		<!-- Adaptive Learning Rate -->
		<define name="USE_ADAPTIVE"				value="FALSE"/>
		<define name="ADAPTIVE_MU"				value="0.00001"/>

		<!--Priority for each axis (roll, pitch, yaw and thrust)-->
		<define name="WLS_PRIORITIES"			value="{1000, 1000, 1, 100}"/>

	</section>

	<section name="GUIDANCE_V" prefix="GUIDANCE_V_">
		<define name="HOVER_KP"					value="150"/>
		<define name="HOVER_KD"					value="80"/>
		<define name="HOVER_KI"					value="20"/>
		<define name="NOMINAL_HOVER_THROTTLE"	value="0.5"/>
		<define name="ADAPT_THROTTLE_ENABLED"	value="TRUE"/>
	</section>

	<section name="GUIDANCE_H" prefix="GUIDANCE_H_">
		<define name="MAX_BANK"			value="20" unit="deg"/>
		<define name="USE_SPEED_REF"	value="TRUE"/>
		<define name="PGAIN"			value="50"/>
		<define name="DGAIN"			value="100"/>
		<define name="AGAIN"			value="70"/>
		<define name="IGAIN"			value="20"/>
	</section>

	<section name="NAV">
		<define name="ARRIVED_AT_WAYPOINT" value="0.2" unit="m"/>
	</section>

	<section name="BAT">
		<define name="CATASTROPHIC_BAT_LEVEL"		value="12.4" unit="V"/>
		<define name="CRITIC_BAT_LEVEL"				value="14.0" unit="V"/>
		<define name="LOW_BAT_LEVEL"				value="14.8" unit="V"/>
		<define name="MAX_BAT_LEVEL"				value="16.8" unit="V"/>
		<define name="MILLIAMP_AT_FULL_THROTTLE"	value="30000"/>
	</section>

	<section name="SIMULATOR" prefix="NPS_">

		<define name="ACTUATOR_NAMES"	value="front_motor, right_motor, back_motor, left_motor"	type="string[]"/>
		<define name="JSBSIM_MODEL"		value="simple_quad"											type="string"/>
		<define name="SENSORS_PARAMS"	value="nps_sensors_params_default.h"						type="string"/>

		<!-- mode switch on joystick ch5 (numbering starts at zero) -->
		<define name="JS_AXIS_MODE"		value="4"/>

	</section>

	<section name="AUTOPILOT">
		<define name="MODE_MANUAL"			value="AP_MODE_RC_DIRECT"/>
		<define name="MODE_AUTO1"			value="AP_MODE_ATTITUDE_DIRECT"/>
		<define name="MODE_AUTO2"			value="AP_MODE_HOVER_Z_HOLD"/>
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_CARE_FREE_DIRECT"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_ATTITUDE_Z_HOLD"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_HOVER_DIRECT"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_HOVER_Z_HOLD"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_NAV"/> -->
		<define name="NO_RC_THRUST_LIMIT"	value="FALSE"/>
	</section>

</airframe>
