<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="Quadplane LisaM_2.0 pwm">

	<description>
		Quadplane:
		- modified mini-talon with cobra 2814/16 Kv1050 running a 10x8 prop
		- quad with KISS esc + cobra 2207/2450kv running 6x3 props
	</description>

	<!-- FIRMWARE -->

	<firmware name="rotorcraft">

		<target name="ap" board="lisa_mx_2.1">
			<!-- MPU6000 is configured to output data at 2kHz, but polled at 512Hz PERIODIC_FREQUENCY -->
		</target>

		<target name="nps" board="pc">
			<module name="fdm" type="jsbsim"/>
		</target>

		<module name="radio_control" type="spektrum">
			<define name="RADIO_MODE"						value="RADIO_GEAR"/>
			<define name="RADIO_FORWARD_THRUST"				value="RADIO_AUX2"/>
			<define name="RADIO_KILL_SWITCH"				value="RADIO_AUX1"/>
			<define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING"	value="1" />
		</module>

		<module name="actuators" type="pwm">
			<define name="SERVO_HZ" value="400"/>
			<define name="USE_SERVOS_7AND8"/>
		</module>

		<module name="telemetry" type="xbee_api"/>
		<module name="imu" type="aspirin_v2.2"/>
		<module name="gps" type="datalink"/>
		<!-- <module name="servo_tester"/> -->

		<module name="stabilization" type="inca">
			<define name="INDI_RPM_FEEDBACK"	value="FALSE"/>
		</module>

		<module name="ahrs" type="int_cmpl_quat">
			<configure	name="USE_MAGNETOMETER"					value="FALSE"/>
			<define		name="AHRS_GRAVITY_HEURISTIC_FACTOR"	value="0"/>
		</module>

		<module name="ins" type="extended"/>
		<module name="geo_mag"/>
		<module name="sys_mon"/>
		<!-- <module name="air_data"/> -->

		<!--define name="KILL_ON_GROUND_DETECT" value="TRUE"/-->

	</firmware>

	<!-- COMMANDS -->

	<commands>
		<axis name="ROLL"			failsafe_value="0"/>
		<axis name="PITCH"			failsafe_value="0"/>
		<axis name="YAW"			failsafe_value="0"/>
		<axis name="THRUST"			failsafe_value="0"/>
		<axis name="FORWARD_THRUST"	failsafe_value="0"/>
	</commands>

	<rc_commands>
		<set command="FORWARD_THRUST" value="@FORWARD_THRUST"/>
	</rc_commands>

	<!-- SERVOS -->

	<servos driver="Pwm">
		<servo name="FRONT_LEFT"		no="0" min="1000" neutral="1100" max="1900"/>
		<servo name="FRONT_RIGHT"		no="1" min="1000" neutral="1100" max="1900"/>
		<servo name="BACK_RIGHT"		no="2" min="1000" neutral="1100" max="1900"/>
		<servo name="BACK_LEFT"			no="3" min="1000" neutral="1150" max="1900"/>
		<servo name="AILERONS"			no="4" min="1000" neutral="1470" max="1900"/>
		<servo name="RUDDERVATOR_LEFT"	no="5" min="1000" neutral="1500" max="2000"/>
		<servo name="RUDDERVATOR_RIGHT"	no="6" min="1000" neutral="1470" max="2000"/>
		<servo name="FLYMOTOR"			no="7" min="1000" neutral="1100" max="1900"/>
	</servos>

	<!-- COMMANDS LAWS -->

	<command_laws>
	
		<!-- Quadcopter actuatortor set -->
		<set servo="FRONT_LEFT"			value="autopilot_get_motors_on() ? actuators_pprz[0] : -MAX_PPRZ"/>
		<set servo="FRONT_RIGHT"		value="autopilot_get_motors_on() ? actuators_pprz[1] : -MAX_PPRZ"/>
		<set servo="BACK_RIGHT"			value="autopilot_get_motors_on() ? actuators_pprz[2] : -MAX_PPRZ"/>
		<set servo="BACK_LEFT"			value="autopilot_get_motors_on() ? actuators_pprz[3] : -MAX_PPRZ"/>

		<!-- Fixed wing actuator set -->
		<set servo="AILERONS"			value="autopilot_get_motors_on() ? actuators_pprz[4] : 0"/>
		<set servo="RUDDERVATOR_LEFT"	value="autopilot_get_motors_on() ? actuators_pprz[5] : 0"/>
		<set servo="RUDDERVATOR_RIGHT"	value="autopilot_get_motors_on() ? actuators_pprz[6] : 0"/>
		
		<!-- Tail rotor -->
		<set servo="FLYMOTOR"			value="autopilot_get_motors_on() ? @FORWARD_THRUST : -MAX_PPRZ"/>

		<!-- Quadcopter actuatortor set -->
		<!-- <set servo="FRONT_LEFT"			value="-MAX_PPRZ"/> -->
		<!-- <set servo="FRONT_RIGHT"		value="-MAX_PPRZ"/> -->
		<!-- <set servo="BACK_RIGHT"			value="-MAX_PPRZ"/> -->
		<!-- <set servo="BACK_LEFT"			value="autopilot_get_motors_on() ? @THRUST : -MAX_PPRZ"/> -->

		<!-- Fixed wing actuator set -->
		<!-- <set servo="FLYMOTOR"			value="0"/> -->
		<!-- <set servo="AILERONS"			value="0"/> -->
		<!-- <set servo="RUDDERVATOR_LEFT"	value="0"/> -->
		<!-- <set servo="RUDDERVATOR_RIGHT"	value="0"/> -->
		
		<!-- Tail rotor -->		
		<!-- <set servo="FLYMOTOR"			value="-MAX_PPRZ"/> -->
		
		

	</command_laws>

	<!-- SETTINGS -->

	<section name="IMU" prefix="IMU_">

		<!-- Replace this with your own calibration -->
		<define name="MAG_X_NEUTRAL"		value="-102"/>
		<define name="MAG_Y_NEUTRAL"		value="-69"/>
		<define name="MAG_Z_NEUTRAL"		value="96"/>
		<define name="MAG_X_SENS"			value="3.7163763222485424"	integer="16"/>
		<define name="MAG_Y_SENS"			value="3.667894315633858"	integer="16"/>
		<define name="MAG_Z_SENS"			value="4.040080277772171"	integer="16"/>

		<define name="BODY_TO_IMU_PHI"		value="0."					unit="deg"/>
		<define name="BODY_TO_IMU_THETA"	value="0."					unit="deg"/>
		<define name="BODY_TO_IMU_PSI"		value="180."				unit="deg"/>

	</section>

	<section name="AHRS" prefix="AHRS_">

		<!-- Delft magnetic field -->
		<define name="H_X"							value="0.39049610"/>
		<define name="H_Y"							value="0.00278894"/>
		<define name="H_Z"							value="0.92060036"/>
		<define name="USE_GPS_HEADING"				value="1"/>
		<define name="HEADING_UPDATE_GPS_MIN_SPEED"	value="0"/>

		<!-- For vibrating airfames -->
		<define name="GRAVITY_HEURISTIC_FACTOR"		value="0"/>

	</section>

	<section name="INS" prefix="INS_">
		<define name="USE_GPS_ALT"			value="1"/>
		<define name="USE_GPS_ALT_SPEED"	value="1"/>
	</section>

	<section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">

		<!-- Setpoints -->
		<define name="SP_MAX_PHI"	value="45."		unit="deg"/>
		<define name="SP_MAX_THETA"	value="45."		unit="deg"/>
		<define name="SP_MAX_R"		value="90."		unit="deg/s"/>
		<define name="DEADBAND_A"	value="0"/>
		<define name="DEADBAND_E"	value="0"/>
		<define name="DEADBAND_R"	value="10"/>

		<!-- Reference -->
		<define name="REF_OMEGA_P"	value="400"		unit="deg/s"/>
		<define name="REF_ZETA_P"	value="0.85"/>
		<define name="REF_MAX_P"	value="400."	unit="deg/s"/>
		<define name="REF_MAX_PDOT"	value="RadOfDeg(8000.)"/>

		<define name="REF_OMEGA_Q"	value="400"		unit="deg/s"/>
		<define name="REF_ZETA_Q"	value="0.85"/>
		<define name="REF_MAX_Q"	value="400."	unit="deg/s"/>
		<define name="REF_MAX_QDOT"	value="RadOfDeg(8000.)"/>

		<define name="REF_OMEGA_R"	value="250"		unit="deg/s"/>
		<define name="REF_ZETA_R"	value="0.85"/>
		<define name="REF_MAX_R"	value="180."	unit="deg/s"/>
		<define name="REF_MAX_RDOT"	value="RadOfDeg(1800.)"/>

	</section>

	<section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
		
		<!-- Virtual input and actuator vector dimensions -->
		<define name="INDI_OUTPUTS"				value="4"/>
		<define name="INDI_NUM_ACT"				value="7"/>
		
		<!-- Actuator properties -->
		<define name="ACT_DYN"					value="{  29.0,   29.0,   29.0,   29.0,  100.0,  100.0,  100.0  }"/>
		<define name="ACT_IS_SERVO"				value="{     0,      0,      0,      0,      1,      1,      1  }"/>
		<define name="ACT_IS_THRUST"			value="{     1,      1,      1,      1,      0,      0,      0  }"/>
		<define name="ACT_IS_SURFACE"			value="{     0,      0,      0,      0,      1,      1,      1  }"/>
		<define name="ACT_RATE_LIMIT"			value="{  9600,   9600,   9600,   9600,   9600,   9600,   9600  }"/>
		<define name="ACT_PREF"					value="{     0,      0,      0,      0,      0,      0,      0  }"/>
		<define name="ACT_PRIORITIES"			value="{     1,      1,      1,      1,     10,     10,     10  }"/>
		
		<!-- Control effectiveness -->
		<define name="G1_ROLL"					value="{  11.0,  -11.0,  -11.0,   11.0,    0.15,   0.0,    0.0  }"/>
		<define name="G1_PITCH"					value="{   9.0,    9.0,   -9.0,   -9.0,    0.0,    0.11,  -0.11 }"/>
		<define name="G1_YAW"					value="{  -0.60,   0.60,  -0.60,   0.60,   0.0,   -0.03,  -0.03 }"/>
		<define name="G1_THRUST"				value="{  -0.80,  -0.80,  -0.80,  -0.80,   0.0,    0.0,    0.0  }"/>

		<!-- Counter torque effect of spinning up a rotor -->
		<define name="G2"						value="{ -55.0,   55.0,  -55.0,   55.0,    0.0,    0.0,    0.0  }"/>
		
		<!-- 1.2     1.2     -1.2    -1.2    -1.5    -1.5    0.139   -0.139; -->
		<!-- 1.8     -1.8    1.8     -1.8    0       0       -1.14   -1.14; -->
		<!-- -0.06   0.06    0.06    -0.06   -0.25   0.25    -0.05   0.25]; -->
		<!-- -6      -6      -6      -6      3       -3      -2.5    -2.5; -->

		<!-- Reference acceleration for attitude control -->
		<define name="REF_ERR_P"				value="200.0"/>
		<define name="REF_ERR_Q"				value="200.0"/>
		<define name="REF_ERR_R"				value="150.0"/>
		<define name="REF_RATE_P"				value="28.0"/>
		<define name="REF_RATE_Q"				value="28.0"/>
		<define name="REF_RATE_R"				value="28.0"/>

		<define name="ESTIMATION_FILT_CUTOFF"	value="4.0"/>
		<define name="FILT_CUTOFF"				value="5.0"/>

		<!-- Adaptive Learning Rate -->
		<define name="USE_ADAPTIVE"				value="FALSE"/>
		<define name="ADAPTIVE_MU"				value="0.00001"/>

		<!--Priority for each axis (roll, pitch, yaw and thrust)-->
		<define name="WLS_PRIORITIES"			value="{100, 100, 1, 1000}"/>

	</section>

	<section name="GUIDANCE_V" prefix="GUIDANCE_V_">
		<define name="HOVER_KP"					value="150"/>
		<define name="HOVER_KD"					value="80"/>
		<define name="HOVER_KI"					value="20"/>
		<define name="NOMINAL_HOVER_THROTTLE"	value="0.5"/>
		<define name="ADAPT_THROTTLE_ENABLED"	value="TRUE"/>
	</section>

	<section name="GUIDANCE_H" prefix="GUIDANCE_H_">
		<define name="MAX_BANK"			value="20" unit="deg"/>
		<define name="USE_SPEED_REF"	value="TRUE"/>
		<define name="PGAIN"			value="50"/>
		<define name="DGAIN"			value="100"/>
		<define name="AGAIN"			value="70"/>
		<define name="IGAIN"			value="20"/>
	</section>

	<section name="NAV">
		<define name="ARRIVED_AT_WAYPOINT" value="0.2" unit="m"/>
	</section>

	<section name="BAT">
		<define name="CATASTROPHIC_BAT_LEVEL"		value="13.2" unit="V"/>
		<define name="CRITIC_BAT_LEVEL"				value="14.0" unit="V"/>
		<define name="LOW_BAT_LEVEL"				value="14.8" unit="V"/>
		<define name="MAX_BAT_LEVEL"				value="16.8" unit="V"/>
		<define name="MILLIAMP_AT_FULL_THROTTLE"	value="30000"/>
	</section>

	<section name="SIMULATOR" prefix="NPS_">

		<define name="ACTUATOR_NAMES"	value="front_motor, right_motor, back_motor, left_motor"	type="string[]"/>
		<define name="JSBSIM_MODEL"		value="simple_quad"											type="string"/>
		<define name="SENSORS_PARAMS"	value="nps_sensors_params_default.h"						type="string"/>

		<!-- Mode switch on joystick ch5 (numbering starts at zero) -->
		<define name="JS_AXIS_MODE"		value="4"/>

	</section>

	<section name="AUTOPILOT">
		<define name="MODE_MANUAL"			value="AP_MODE_RC_DIRECT"/>
		<define name="MODE_AUTO1"			value="AP_MODE_ATTITUDE_DIRECT"/>
		<define name="MODE_AUTO2"			value="AP_MODE_NAV"/>
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_CARE_FREE_DIRECT"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_ATTITUDE_Z_HOLD"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_HOVER_DIRECT"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_HOVER_Z_HOLD"/> -->
		<!-- <define name="MODE_AUTO2"			value="AP_MODE_NAV"/> -->
		<define name="NO_RC_THRUST_LIMIT"	value="FALSE"/>
	</section>

</airframe>
